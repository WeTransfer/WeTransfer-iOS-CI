# rubocop:disable LineLength
desc 'Validates the changes with SwiftLint and Danger'
lane :validate_changes do |options|
  # Run Danger
  danger(dangerfile: "#{Dir.pwd.gsub(/ /, '\ ')}/../Submodules/WeTransfer-iOS-CI/Danger/Dangerfile", verbose: true)
end

desc 'Tests the WeTransferPRLinter Swift Package'
lane :test do |options|

	# Clean old reports so they're not reported for no reason.
	reports_dir = "./../build/reports"
	FileUtils.rm_rf Dir.glob("#{reports_dir}/*") if File.directory?(reports_dir)

	spm(command: "generate-xcodeproj", package_path: "Danger-Swift")

	begin
		ENV["XCPRETTY_JSON_FILE_OUTPUT"] = "build/reports/WeTransferPRLinter_Tests.json"
		scan(
		  scheme: "WeTransferPRLinter-Package",
		  project: "Danger-Swift/WeTransferPRLinter.xcodeproj",
		  skip_detect_devices: true,
		  code_coverage: true,
		  fail_build: false,
		  skip_slack: true,
		  output_types: "",
		  include_simulator_logs: true,
		  formatter: "xcpretty-json-formatter",
		  xcargs: "-UseNewBuildSystem=YES CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO ONLY_ACTIVE_ARCH=NO",
		  result_bundle: true,
		  output_directory: "build/reports/"
		)
	rescue => ex
		UI.important("Tests failed for #{ex}")
	end
end
